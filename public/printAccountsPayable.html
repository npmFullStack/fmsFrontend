<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounts Payable Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 20px;
        }
        
        .table-container {
            width: 100%;
            background-color: white;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .table-title {
            background-color: #1e3a8a;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 20px;
            padding: 12px;
            text-transform: uppercase;
            border: 2px solid #000;
        }
        
        th {
            background-color: #7e4200;
            color: #fff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 9px;
            padding: 6px 4px;
            text-align: left;
            border-right: 1px solid #ff9d0c;
            height: 15px;
            text-align: center;
            border-bottom: 2px solid #00c400;
        }
        
        th:last-child {
            border-right: none;
        }
        
        td {
            padding: 4px 4px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 8px;
            text-transform: uppercase;
            height: 25px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
            vertical-align: top;
        }
        
        .date-cell {
            font-weight: bold;
            color: #1e3a8a;
        }
        
        .amount {
            font-weight: bold;
            color: #2d3748;
        }
        
        .print-info {
            margin: 10px 0;
            font-size: 12px;
            color: #666;
        }

        /* Column width adjustments */
        th:nth-child(1), td:nth-child(1) { width: 8%; }
        th:nth-child(2), td:nth-child(2) { width: 10%; }
        th:nth-child(3), td:nth-child(3) { width: 8%; }
        th:nth-child(4), td:nth-child(4) { width: 8%; }
        th:nth-child(5), td:nth-child(5) { width: 10%; }
        th:nth-child(6), td:nth-child(6) { width: 8%; }
        th:nth-child(7), td:nth-child(7) { width: 8%; }
        th:nth-child(8), td:nth-child(8) { width: 8%; }
        th:nth-child(9), td:nth-child(9) { width: 8%; }
        th:nth-child(10), td:nth-child(10) { width: 8%; }
        th:nth-child(11), td:nth-child(11) { width: 8%; }
        th:nth-child(12), td:nth-child(12) { width: 8%; }

        @media print {
            body {
                background: white;
                padding: 0;
                margin: 0;
            }
            .table-container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="print-info">
        Generated on: <span id="printDate"></span> | 
        Records: <span id="recordCount">0</span>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <td colspan="12" class="table-title" id="tableTitle">Accounts Payable Report</td>
                </tr>
                <tr id="tableHeaders">
                    <!-- Headers will be populated by JavaScript -->
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Data will be populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        // Single line headers for accounts payable
        const headers = [
            'HWB No.', 'Client', 'Mode', 'Route', 'Volume', 
            'Freight Amount', 'Trucking Amount', 'Port Amount', 
            'Misc Amount', 'Total Expense', 'Voucher', 'Check Date'
        ];

        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '';
            return '₱' + parseFloat(amount).toLocaleString('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return '<span class="date-cell">' + date.toLocaleDateString() + '</span>';
            } catch (e) {
                return '';
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return '<span class="date-cell">' + date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + '</span>';
            } catch (e) {
                return '';
            }
        }

        function calculateTotalAmount(chargesArray) {
            if (!chargesArray || !Array.isArray(chargesArray)) return 0;
            return chargesArray.reduce((total, charge) => total + (parseFloat(charge.amount) || 0), 0);
        }

        function populateTable() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            const multipleParam = urlParams.get('multiple');
            
            if (dataParam) {
                try {
                    const data = JSON.parse(decodeURIComponent(dataParam));
                    const printDate = new Date().toLocaleString();
                    
                    document.getElementById('printDate').textContent = printDate;
                    
                    // Handle single or multiple records
                    const records = multipleParam === 'true' ? data : [data];
                    document.getElementById('recordCount').textContent = records.length;
                    
                    // Set table title
                    document.getElementById('tableTitle').textContent = 'Accounts Payable Report';
                    
                    // Set headers
                    const headerRow = document.getElementById('tableHeaders');
                    headerRow.innerHTML = headers.map(header => 
                        `<th>${header}</th>`
                    ).join('');
                    
                    // Populate table body with all records
                    const tableBody = document.getElementById('tableBody');
                    tableBody.innerHTML = '';
                    
                    records.forEach((record, index) => {
                        const booking = record.booking || {};
                        
                        // Calculate amounts
                        const freightAmount = record.freight_charge?.amount || 0;
                        const truckingAmount = calculateTotalAmount(record.trucking_charges);
                        const portAmount = calculateTotalAmount(record.port_charges);
                        const miscAmount = calculateTotalAmount(record.misc_charges);
                        const totalExpense = record.total_expenses || 0;
                        
                        // Get voucher and check date (prioritize freight charge if available)
                        const voucher = record.freight_charge?.voucher_number || '';
                        const checkDate = record.freight_charge?.check_date || '';
                        
                        const row = document.createElement('tr');
                        
                        // Add alternating row background for better readability
                        if (index % 2 === 0) {
                            row.style.backgroundColor = '#f8f9fa';
                        }
                        
                        row.innerHTML = `
                            <td>${booking.hwb_number || ''}</td>
                            <td>${(booking.first_name || '') + ' ' + (booking.last_name || '')}</td>
                            <td>${booking.mode_of_service || ''}</td>
                            <td>${(booking.origin?.route_name || booking.origin?.name || '') + ' → ' + (booking.destination?.route_name || booking.destination?.name || '')}</td>
                            <td>${(booking.container_quantity || '1') + ' x ' + (booking.container_size?.size || booking.container_size?.name || '')}</td>
                            <td class="amount">${formatCurrency(freightAmount)}</td>
                            <td class="amount">${formatCurrency(truckingAmount)}</td>
                            <td class="amount">${formatCurrency(portAmount)}</td>
                            <td class="amount">${formatCurrency(miscAmount)}</td>
                            <td class="amount">${formatCurrency(totalExpense)}</td>
                            <td>${voucher}</td>
                            <td>${formatDate(checkDate)}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // Auto-print after loading
                    setTimeout(() => {
                        window.print();
                    }, 500);
                    
                } catch (error) {
                    console.error('Error parsing data:', error);
                    document.body.innerHTML = '<div style="text-align: center; padding: 50px; font-size: 16px;">Error loading accounts payable data</div>';
                }
            } else {
                document.body.innerHTML = '<div style="text-align: center; padding: 50px; font-size: 16px;">No data provided for printing</div>';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', populateTable);
    </script>
</body>
</html>